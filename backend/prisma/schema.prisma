generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int                @id @default(autoincrement())
  name               String
  email              String             @unique
  password           String
  createdAt          DateTime           @default(now())
  profile            Profile?
  clubs              Club[]
  memberships        ClubMember[]
  discussionPosts    DiscussionPost[]
  discussionReplies  DiscussionReply[]
  // Friend relations (two directions)
  sentFriendRequests     Friend[]           @relation("Friend_User")
  receivedFriendRequests Friend[]           @relation("Friend_Friend")
  // Vote relations
  discussionPostVotes    DiscussionPostVote[]
  discussionReplyVotes   DiscussionReplyVote[]
}

model Friend {
        id	          Int @id @default(autoincrement())
	userID	          Int 
	user	          User @relation("Friend_User", fields: [userID], references: [id])
	friendID	  Int 
	friend		  User @relation("Friend_Friend", fields: [friendID], references: [id])
	status	          FriendStatus //PENDING, ACCEPTED, or REJECTED
	@@unique([userID, friendID])
}

enum FriendStatus {
        PENDING
	ACCEPTED
	REJECTED
}

model Profile {
  id             Int      @id @default(autoincrement())
  username       String   @unique
  fullName       String
  profilePicture String?
  bio            String?
  joinDate       DateTime @default(now())
  userId         Int      @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Club {
  id              Int              @id @default(autoincrement())
  name            String
  description     String?
  createdAt       DateTime         @default(now())
  creatorId       Int
  creator         User             @relation(fields: [creatorId], references: [id])
  currentBookId   String?
  currentBookData Json?
  readingGoal     String?
  goalDeadline    DateTime?
  members         ClubMember[]
  discussions     DiscussionPost[]
}

model ClubMember {
  id       Int      @id @default(autoincrement())
  role     Role
  clubId   Int
  userId   Int
  progress Int      @default(0)
  joinedAt DateTime @default(now())
  club     Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
}

enum Role {
  HOST
  MODERATOR
  MEMBER
}

model DiscussionPost {
id Int @id @default(autoincrement())
datePosted DateTime @default(now())
dateEdited DateTime?
hasMedia Boolean @default(false)
clubId Int
userId Int
title String
chapterIndex Int?
tags Json?
pinned Boolean @default(false)
locked Boolean @default(false)
contentId Int @unique

club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
user User @relation(fields: [userId], references: [id], onDelete: Cascade)

content DiscussionPostContent @relation("Post_Content", fields: [contentId], references: [id], onDelete: Cascade)
media DiscussionPostMedia[]
replies DiscussionReply[]
 votes DiscussionPostVote[]
}

model DiscussionPostContent {
id Int @id @default(autoincrement())
message String

post DiscussionPost? @relation("Post_Content")
}

model DiscussionPostMedia {
id Int @id @default(autoincrement())
file String
fileType String
discussionId Int
discussion DiscussionPost @relation(fields: [discussionId], references: [id], onDelete: Cascade)
}

model DiscussionReply {
  id           Int              @id @default(autoincrement())
  discussionId Int
  parentId     Int?
  userId       Int
  body         String
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now())
  discussion   DiscussionPost   @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent       DiscussionReply? @relation("ReplyToParent", fields: [parentId], references: [id])
  children     DiscussionReply[] @relation("ReplyToParent")
  votes        DiscussionReplyVote[]
}

// Votes on discussion posts
model DiscussionPostVote {
  id           Int            @id @default(autoincrement())
  userId       Int
  discussionId Int
  // value of 1 for upvote, -1 for downvote
  value        Int

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  discussion   DiscussionPost @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  @@unique([userId, discussionId])
  @@index([discussionId])
  @@index([userId])
}

// Votes on discussion replies
model DiscussionReplyVote {
  id       Int              @id @default(autoincrement())
  userId   Int
  replyId  Int
  // value of 1 for upvote, -1 for downvote
  value    Int

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  reply    DiscussionReply  @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@unique([userId, replyId])
  @@index([replyId])
  @@index([userId])
}

