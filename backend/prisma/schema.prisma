generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int                @id @default(autoincrement())
  name               String
  email              String             @unique
  password           String
  createdAt          DateTime           @default(now())
  profile            Profile?
  clubs              Club[]
  memberships        ClubMember[]
  discussionPosts    DiscussionPost[]
  discussionReplies  DiscussionReply[]
  // Friend relations (two directions)
  friendsAsFriend     Friend[]            @relation("FriendUsers")
  friendsAsUser       Friend[]            @relation("UserFriends")
  // Vote relations
  discussionPostVotes    DiscussionPostVote[]
  discussionReplyVotes   DiscussionReplyVote[]
  // Club invitation relations
  sentInvitations        ClubInvitation[]      @relation("Inviter")
  receivedInvitations    ClubInvitation[]     @relation("Invitee")
  messages          Message[]
  directMessagesSent          DirectMessage[]       @relation("SentMessages")
  directMessagesReceived      DirectMessage[]                        @relation("ReceivedMessages")
  dmMessagesSent    DMMessage[]         @relation("UserSentMessages")
  dmMessagesReceived    DMMessage[]         @relation("UserReceivedMessages")
}

model Friend {
  id       Int          @id @default(autoincrement())
  userID   Int
  friendID Int
  status   FriendStatus
  friend   User         @relation("FriendUsers", fields: [friendID], references: [id])
  user     User         @relation("UserFriends", fields: [userID], references: [id])

  @@unique([userID, friendID])
}

enum FriendStatus {
        PENDING
	ACCEPTED
	REJECTED
}

model Profile {
  id             Int      @id @default(autoincrement())
  username       String   @unique
  fullName       String
  profilePicture String?
  bio            String?
  joinDate       DateTime @default(now())
  userId         Int      @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Club {
  id              Int             @id @default(autoincrement())
  name            String
  description     String?
  createdAt       DateTime        @default(now())
  creatorId       Int
  creator         User            @relation(fields: [creatorId], references: [id])
  currentBookId   String?
  currentBookData Json?
  readingGoal     String?
  goalDeadline    DateTime?
  members         ClubMember[]
  discussionPosts DiscussionPost[]
  invitations     ClubInvitation[]
  messages          Message[]
}

model ClubMember {
  id       Int      @id @default(autoincrement())
  clubId   Int
  userId   Int
  progress Int      @default(0)
  joinedAt DateTime @default(now())
  club     Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
}

model ClubInvitation {
  id        Int      @id @default(autoincrement())
  clubId    Int
  inviterId Int
  inviteeId Int
  status    ClubInvitationStatus @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  
  club     Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  inviter  User     @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee  User     @relation("Invitee", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([clubId, inviteeId])
  @@index([inviteeId])
  @@index([clubId])
}

enum ClubInvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model DiscussionPost {
  id          Int                   @id @default(autoincrement())
  datePosted  DateTime              @default(now())
  dateEdited  DateTime?
  hasMedia    Boolean               @default(false)
  title       String
  chapterIndex Int?
  locked      Boolean               @default(false)
  pinned      Boolean               @default(false)
  tags        Json?
  clubId      Int
  userId      Int
  contentId   Int                   @unique
  club        Club                 @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  content     DiscussionPostContent @relation("PostContent", fields: [contentId], references: [id], onDelete: Cascade)
  media       DiscussionPostMedia[]
  replies     DiscussionReply[]
  votes       DiscussionPostVote[]
}

model DiscussionPostContent {
  id        Int            @id @default(autoincrement())
  message   String
  post      DiscussionPost? @relation("PostContent")
}

model DiscussionPostMedia {
  id           Int          @id @default(autoincrement())
  file         String
  fileType     String
  discussionId Int
  discussion   DiscussionPost @relation(fields: [discussionId], references: [id], onDelete: Cascade)
}

model DiscussionReply {
  id           Int          @id @default(autoincrement())
  discussionId Int
  parentId     Int?
  userId       Int
  body         String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt
  discussion   DiscussionPost @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent       DiscussionReply? @relation("ReplyReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies      DiscussionReply[] @relation("ReplyReplies")
  votes        DiscussionReplyVote[]
}

// Votes on discussion posts
model DiscussionPostVote {
  id           Int            @id @default(autoincrement())
  userId       Int
  discussionId Int
  // value of 1 for upvote, -1 for downvote
  value        Int

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  discussion   DiscussionPost @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  @@unique([userId, discussionId])
  @@index([discussionId])
  @@index([userId])
}

// Votes on discussion replies
model DiscussionReplyVote {
  id       Int              @id @default(autoincrement())
  userId   Int
  replyId  Int
  // value of 1 for upvote, -1 for downvote
  value    Int

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  reply    DiscussionReply  @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@unique([userId, replyId])
  @@index([replyId])
  @@index([userId])
}

model Message {
  id        Int      @id @default(autoincrement())
  clubId    Int
  userId    Int
  content   String   @db.Text
  createdAt DateTime @default(now())

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clubId, createdAt])
}

model DirectMessage {
  id        Int      @id @default(autoincrement())
  user1Id   Int
  user2Id   Int
  user1     User @relation("SentMessages", fields: [user1Id], references: [id], onDelete: Cascade)
  user2     User @relation("ReceivedMessages", fields: [user2Id], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
  messages  DMMessage[]
  @@unique([user1Id, user2Id], name: "user1Id_user2Id")
}

model DMMessage {
  id               Int      @id @default(autoincrement())
  conversationId   Int
  senderId         Int
  receiverId       Int
  content          String
  createdAt        DateTime @default(now())

  conversation     DirectMessage @relation(fields: [conversationId], references: [id])

  sender           User @relation("UserSentMessages", fields: [senderId], references: [id])
  receiver         User @relation("UserReceivedMessages", fields: [receiverId], references: [id])
}

